# 1 基本介绍

* 主要分为功能权限和数据权限
* 功能权限：如页面是否可见，按钮是否可用，用户可以看到哪些选项等
* 数据权限：用户在使用某个功能权限时（例如查询所有项目），对可以得到的数据的范围的控制

## 1.1 设计方法
* 功能权限主要使用rbac模型，即 用户-角色-功能点，功能点就是具体的功能权限，如“添加项目”，“编辑流水线”等，是原子性的操作，可以为角色分配多个功能点，
该角色就可以执行这些功能点，再为用户分配一至多个角色，用户就可以通过角色使用这些功能点。具体方法是 分别建立 用户-角色关联表和 角色-功能点关联表，来
实现这种多对多的关系。

## 1.2 主要表介绍

只介绍重要的字段和大体结构

* 功能点表

| 字段名   |      含义         |
|:--------:|:---------------:|
| id      |         id       |
| description  | 对功能点的具体描述 |
| is_private    | 表示是否私有，之后可能会有继承功能，暂时没用到 |
| parent_id|  父功能点ID，之后可能会有继承功能，暂时没用到 |

* 角色表

| 字段名   |      含义         |
|:--------:|:---------------:|
| id      |      id         |
| parent_id|  父角色ID，之后可能会有继承功能，暂时没用到 |

* 用户表（不在权限模块下）

仅需要用户的 ID、 名称

* 角色-功能点关联表

| 字段名   |      含义         |
|:--------:|:---------------:|
| id      |         id       |
| permission_id  | 功能点ID |
| role_id    | 角色ID  |

* 用户-角色关联表

| 字段名   |      含义         |
|:--------:|:---------------:|
| id      |         id       |
| user_id  | 用户ID |
| role_id    | 角色ID  |

* 用户数据规则表

| 字段名   |      含义         |
|:--------:|:---------------:|
| id      |         id       |
| role_id    | 角色ID，说明此规则应用在哪个角色上  |
| rule    | 具体规则，例如"in", "equals"等  |
| field_name    | 规则作用的参数名称   |
| description   | 对规则的具体解释 |

* 用户可操作数据表

| 字段名   |      含义         |
|:--------:|:---------------:|
| id      |         id       |
| user_id    | 用户ID，说明这条数据可以被哪个用户操作  |
| rule_id    | 规则id  |
| field_value   | 规则作用的参数的值，通过这个值过滤出可被操作的数据 |
| description   | 对规则的具体解释 |

# 2 权限用法 

以角色模块为例，在角色管理中有实现代码。
## 2.1 后端开发API时，使用权限服务控制功能点

### 2.1.1 创建功能点，并绑定到用户
在网页上（dop平台）进入权限管理-功能点管理-点击创建功能点，填写具体信息（父功能点暂时可以不填写，私有性暂时都填公有），例如我创建一个 “创建角色” 功能点；

创建相应角色，把功能点添加到该角色，例如我创建“权限管理员”角色，把“创建角色”添加到其下；

给用户分配角色，例如我是用户lzy，把“权限管理员”添加到用户“lzy”其下，这样就实现了功能点与用户的绑定。

### 2.1.2 API controller层的参数中加入 userId
在你需要控制权限的API controller层中的函数参数中加入userId，让后端可以验证用户是否具有此权限

如果你的参数中本来就包括userId ，则不需要添加

例如我的创建角色的controller层函数之前如下：

    @ApiOperation(value = "创建角色", notes = "创建角色")
    @PostMapping("/v1/roles")
    public Long createRole(
            @ApiParam(name = "parentId",value = "父角色ID",required = false,defaultValue = "0")
            @RequestParam(value = "parentId", required = false, defaultValue = "0") Long parentId,
            @ApiParam(name = "name",value = "名称",required = true)
            @RequestParam(value = "name", required = true) String name,
            @RequestHeader(HttpHeaders.X_LOGIN_USER) Long loginUser
    )
    {
        return roleService.createRole(parentId,name,loginUser,loginUser);
    }
之前就已经包括了 loginUser 这个参数，即为当前登录用户的ID，所以此函数不需要再添加userId

### 2.1.3 API service层中调用验证函数
首先需要 引入 功能点控制的service，添加如下代码：

    @Autowired
    //功能点service
    private PermissionService permissionService;

之后在API 调用的service函数中，调用 checkUserPermission 函数：

函数原型： 
    
    checkUserPermission(String permissionName,Long userId)
    // 判断 ID为 userId 的用户是否拥有 名为 permissionName的功能点，
    // 有返回 true ，无返回 false

    if(permissionService.checkUserPermission("创建角色",cuser))
         { 
                //验证通过，具有此功能点，要执行的操作
                //此处为创建角色的一些操作
         }
         
 例子：
 
       public Long createRole(Long parentId,String name, Long cuser,Long muser)
        {
            if(permissionService.checkUserPermission("创建角色",cuser))
            {
                Role existRole=this.roleRepository.findByName(name);
                BizAssert.allowed(existRole==null, BizCodes.REPETITIVE_ROLE_NAME);
                Role role= Role.builder()
                        .parentId(parentId)
                        .name(name)
                        .cuser(cuser)
                        .muser(muser)
                        .ctime(LocalDateTime.now())
                        .mtime(LocalDateTime.now())
                        .deleted(false)
                        .build();
                roleRepository.saveAndFlush(role);
                return role.getId();
            }
            return null;
         }
   

## 2.2 后端开发API时，使用权限服务控制数据权限，获取列表

针对情况：某用户是权限管理员，他可以查看一些角色，但应该限定他只能查看自己创建的角色，必要时，他人也可以把自己的角色数据共享给他

即对功能点操作范围的限定。

### 2.2.1 创建数据规则
在网页上（dop平台）进入权限管理-数据权限-点击创建数据权限，例如我想在身为“权限管理员”这个角色的时候，可以查看“roleId 在某范围内的数据”，我应该这样填写：

作用域参数名称：roleId , 规则 : in , 对应角色：选择“权限管理员”

创建完成后，在该条数据规则上面点击添加用户数据按钮，选择应用这条规则的用户，并填写参数值，例如我是用户“lzy”，我的角色是权限管理员，我要求可以查看到属于我的所有角色数据，则用户选择“lzy”，填写作用域参数值（此值之后会实现成批量填写，现在先一个一个填写），如果属于我的角色数据的ID分别是：3，6，7，8，那么将填写 作用域参数值：3（6，7，8同理）。

**可以查看数据规则和用户数据表的描述来进一步理解**

### 2.2.2 API controller层的参数中加入 userId

和功能点控制中的做法一样

### 2.2.3 API service层中调用函数进行数据过滤

首先需要引入 数据权限控制service ：

    @Autowired
    //用户数据
    private UserDataService userDataService;
    
 之后在API调用的函数中，调用 findAllIds函数：
 
 
函数原型： 

    List<Long> findAllIds(String permissionName, Long userId,String fieldName)
    //得到的返回值 为 ID为 userId 的用户 执行 名为 permissionName的操作时，可以操作的数据ID
  
    List<Long> idList=userDataService.findAllIds("查询角色",22,"roleId");
    //这时得到的 idList 是 ID为22 的用户 执行“查询角色”操作时，可以操作的数据ID （即可操作的roleId列表）
    //例如上面已经添加了数据规则和用户数据，实现了 “身为 权限管理员 有权操作 roleId in {3 ,6 ,7 ,8} 的数据” ，
    //那么查询出来的list 为 [3,6,7,8]
 
 以下为具体例子：
 
    //所有数据的列表
    List<Role> roleList = this.roleRepository.findAll(pageRequest).getContent();
    //调用函数后，得到可以操作的数据的ID列表idList
        List<Long> idList=userDataService.findAllIds("查询角色",userId,"roleId");
        List<Role> roleList1=new ArrayList<>();
    //把交集拿出来，放在roleList1中，就过滤出来了可以操作的数据
        for(Role role :roleList)
        {
            for(Long id :idList)
            {
                if(role.getId().equals(id))
                {roleList1.add(role);}
            }
        }
        pagination.setPageList(roleList1.stream().map(p -> BeanUtils.convertType(p, RoleV1.class)).collect(Collectors.toList()));


## 2.3 后端开发API时，使用权限服务控制数据权限，校验

针对情况：某用户是权限管理员，他具有“删除角色”的功能点，在他执行删除操作时，要校验他是否有权删除这一条数据。

即对功能点操作单一数据的校验。

### 2.3.1 创建数据规则

在网页上（dop平台）进入权限管理-数据权限-点击创建数据权限，例如我想在身为“权限管理员”时进行“删除角色”操作，并在此时判断是否有权删除，则填写如下：

作用域参数名称：roleId , **规则 : equals** , 对应角色：选择“权限管理员”

创建完成后，在该条数据规则上面点击添加用户数据按钮，选择应用这条规则的用户，并填写参数值，例如我是用户“lzy”，我的角色是权限管理员，我要求可以删除属于我的所有角色数据，则用户选择“lzy”，填写作用域参数值（此值之后会实现成批量填写，现在先一个一个填写），如果属于我的角色数据的ID分别是：3，6，7，8，那么将填写 作用域参数值：3（6，7，8同理）。

**可以查看数据规则和用户数据表的描述来进一步理解**

### 2.3.2 API controller层的参数中加入 userId

和功能点控制中的做法一样

### 2.2.3 API service层中调用函数进行权限校验

首先需要引入 数据权限控制service ：

    @Autowired
    //用户数据
    private UserDataService userDataService;
    
 之后在API调用的函数中，调用 check函数：
 
    函数原型：
    
    check(String permissionName,Long userId,String fieldName,Long fieldValue)
    //表示 校验 ID 为 userId 的用户是否可以在 fieldName 为 fieldValue 的数据上 执行名为 permissionName 的操作
    //此函数范围值为 boolean ，可以执行返回true ，否则返回false

    userDataService.check("删除角色",22,"roleId",1)
    //表示 校验 ID 为 22 的用户是否可以在 roleId 为 1 的数据上 执行名为 "删除角色" 的操作
    
 以下为具体例子：
 
    public void deleteById(Long id ,Long userId)
    {
       if(userDataService.check("删除角色",userId,"roleId",id))
       {
           rolePermissionMappingService.deleteByRoleId(id);
           userRuleService.deleteByRoleId(id);
           roleRepository.deleteById(id);
       }
    }


# 3 前端 

 * 前端已在DOP平台上实现，可能各个模块需要自己写一个前端？或者都跳转到我这里来？后期可以实现模块化的权限管理，比如项目模块只管理项目模块的权限，代码模块只管理代码模块的权限
 * 等用户服务的查询全部功能完成后，会实现批量加入用户数据的功能
 * 后期可能会用到父角色或父功能点等字段，来实现继承之类的功能（看需求）
 
 
 
