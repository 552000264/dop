# Introduce

> 确定服务器配置、需求、时间人员安排



### 服务器

- v1版本服务器：3台 8G 2核

- 在v1版本的基础不变的情况下，希望master节点需要大一点，若可动态调配cpu内核建议为8G 4核

  > master 节点去年cpu很容易就拉满

- 从11月份到明年毕设结束，最晚估计为7月份



### 云数据库

- mysql
- mongo



### 系统架构

<img src="https://user-images.githubusercontent.com/17808702/67137427-bc869280-f267-11e9-8931-2efecfcc4d23.png" alt="image" style="zoom: 50%;" />

### 需求确定

- 项目管理：整个平台的信息管理中心
  - gitlab地址
  - docker信息
  - 集群信息
  - API信息（可做入口）
  - 监控信息（可做入口）
  - 全流程日志信息（可做入口）

- 代码管理：平台代码管理仓库
- 流水线管理
- 监控管理
- 权限管理
- 日志管理：

  - 日志来源
  - 日志时间
  - 日志分类

- 测试管理

- 监控管理：采用外围监控的方式进行**ISTIO**、**Promethus**
  - 监控告警
  - 链路分析

- API管理
  - 展示
    - 请求数量
    - 吞吐量
    - 响应时间
    - 目前状态
  - 策略：
    - 熔断
    - 限流
    - ...



坑：自动触发

### 监控模块
- 需求细化（需要展示的数据）
  - 基础数据：
    当前平台的网关 API、当前服务数、当前实例数、中间件；
  - 外部请求数：显示24h 内有多少请求访问网关，及访问后的状态码分析和满意度（平均响应时间）统计； 
  - 外部IP 数：显示24h 内来源的IP 数及每个事件刻度下IP 数； 
  - 平台告警：显示24h 内告警总次数；
  - 所属服务：当前实例属于哪一个服务的运行体； 
  - 实例名称：实例的instanceId 信息； 
  - 实例状态：实例的status ，包含：UP、DOWN； 
  - 运行时长：当前时间距离实例注册开始时间的时间差； 
  - 内存使用：已使用的内存/被分配的内存；
<img width="1439" alt="1" src="https://user-images.githubusercontent.com/17808702/64095408-4ac6b800-cd91-11e9-9215-66c5836a2bce.png">

- 难点
  - 两种istio多集群链接方式都需要**对用户集群进行istio配置**
![TIM截图20190903100705](https://user-images.githubusercontent.com/17808702/64139232-ba40b400-ce32-11e9-813f-6546b10ee7cc.png)
![TIM截图20190903100722](https://user-images.githubusercontent.com/17808702/64139233-ba40b400-ce32-11e9-90ae-4d7478aab5be.png)
  - 采用promethus方式需要对**用户代码**进行更改，且不能进行istio api网关层面的管控
- 待决定
  - Prometheus支持自定义指标，但自定义指标可能会影响自带指标的使用
  - 第一步暂时不对用户代码进行埋点，而是进行外围监控
- 实施计划
  - 完善v1版本项目管理与应用管理模块
  - 接入开源监控模块工具
  - 实现看板实时监控与展示，拓展功能

### 告警模块
- 难点
  - 由于应用会被拆分成多个微服务，导致监控数据的爆炸增长，运维人员无法快速处理和展示这些监控数据。
  - 微服务之间的调用关系，导致出现问题时，故障排查很难。
  - 如何通过一个统一的监控系统纳管所有的需求。

- 告警规则配置参数
  - 指标：需要告警的指标信息，详情请参见**告警指标列表**
  - 条件：对监控的“指标”值的判断条件，包括：>、<、=、>=、<=;
  - 阈值：“指标”根据告警条件触发告警事件的临界值；
  - 统计周期：统计多少时间范围内的指标·数据；
  - 重复次数：“指标”达到“阈值”发生了多少次，由于会因为网络原因，会出现抖动情况，可以配置允许多次达到阈值之后才进行告警事件通知。
  - 状态：配置策略的执行与暂停执行；
  - 告警级别：策略重要性标示，包括：一般、严重；
- 配置具体告警实例
  - 接收人：发生告警事件后需要通知的人员信息；
  - 通知方式：邮件
  - 通知间隔：发生告警事件后，如果再次发生相同规则的告警时间，在通知间隔的时间内不再持续通知，避免通知重复，影响造成重要信息查看；
- 实施计划
  - 接入告警模块，配置告警规则及模板
  - 增强告警模块可用性和健壮性
- 告警配置具体步骤
<img width="1439" alt="1" src="https://user-images.githubusercontent.com/17808702/64095953-e6a4f380-cd92-11e9-8783-89ca2cd7ddb3.png">
<img width="1200" alt="2" src="https://user-images.githubusercontent.com/17808702/64095955-e73d8a00-cd92-11e9-891a-60c9b2f727b9.png">
<img width="1195" alt="3" src="https://user-images.githubusercontent.com/17808702/64095956-e73d8a00-cd92-11e9-9dec-8542a5df8cc8.png">
<img width="1199" alt="4" src="https://user-images.githubusercontent.com/17808702/64095957-e7d62080-cd92-11e9-83ef-85b23a77c15a.png">
<img width="1196" alt="5" src="https://user-images.githubusercontent.com/17808702/64095958-e7d62080-cd92-11e9-9487-489227626fee.png">
<img width="1166" alt="6" src="https://user-images.githubusercontent.com/17808702/64095959-e86eb700-cd92-11e9-844a-3b21ca2eb4c5.png">

  
### 链路分析模块
- 难点
  - 从客户端发起请求到服务端接收、处理请求，并返回处理结果给客户端的整个访问路径
  - 相关应用服务器内部的线程处理模型、服务的线程处理模型
  



### 时间安排

- 第一迭代：
  - 11月-12月初     带领学弟熟悉
  - 部署熟悉V1，技术调研
  - 填上v1版本的坑

- 第二迭代

  - 12月- 1月20号（腊月26）
  - 需求收集、初始阶段开发
  - 本机开发

  - 尝试性接入dop平台、监控用起来

- 第三阶段 
  - 2月--4月
  - 完善一些策略

- 第四阶段（时间预留）
  - 4月--5月
  - bug修复



